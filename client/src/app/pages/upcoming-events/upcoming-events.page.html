<main class="page">
  <h1>Upcoming Events</h1>

  <p *ngIf="error" class="error" role="alert">{{ error }}</p>
  <p *ngIf="success" class="success" role="status">{{ success }}</p>

  <section *ngIf="canCreate" class="mt16">
    <button type="button" class="submit" (click)="openSchedulePopup()">Schedule</button>
  </section>

  <section *ngIf="canCreate" class="panel mt16">
    <h2 class="panelTitle">Schedule by ask</h2>
    <p class="mt8">Describe the appointment in plain language, e.g. “schedule user john with attorney jane on 3/3/2026 from 1PM to 2PM”.</p>
    <div class="mt12">
      <textarea
        name="askPrompt"
        [(ngModel)]="askPrompt"
        class="input"
        rows="3"
        placeholder="e.g. schedule user john with attorney jane on 3/3/2026 from 1PM to 2PM"
        [disabled]="askBusy"
      ></textarea>
    </div>
    <p *ngIf="askError" class="error mt8" role="alert">{{ askError }}</p>
    <div class="rowActions mt8">
      <button type="button" class="submit" (click)="submitAskSchedule()" [disabled]="askBusy || !askPrompt.trim()">
        {{ askBusy ? 'Scheduling…' : 'Schedule' }}
      </button>
    </div>
  </section>

  <section class="mt16">
    <div class="rowActions">
      <button type="button" (click)="refresh()" [disabled]="busy">Refresh</button>
      <span *ngIf="busy">Loading…</span>
    </div>

    <table *ngIf="appointments.length > 0" class="table mt12">
      <thead>
        <tr>
          <th class="th">Case #</th>
          <th class="th">Date & time</th>
          <th class="th" *ngIf="isPetitioner">With</th>
          <th class="th" *ngIf="!isPetitioner">Petitioner</th>
          <th class="th">Status</th>
          <th class="th">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of appointments">
          <td class="td">{{ a.caseNumber || '—' }}</td>
          <td class="td">{{ a.scheduledAt | date:'short' }}</td>
          <td class="td" *ngIf="isPetitioner">{{ counterpartyName(a) }}</td>
          <td class="td" *ngIf="!isPetitioner">{{ displayName(a.petitioner) }}</td>
          <td class="td">{{ a.status }}</td>
          <td class="td">
            <span class="rowActions">
              <ng-container *ngIf="isPetitioner && a.status === 'pending'">
                <button type="button" (click)="setStatus(a, 'accepted')" [disabled]="busy" class="submit">Accept</button>
                <button type="button" (click)="openReschedulePrompt(a, 'rejected')" [disabled]="busy">Reject</button>
              </ng-container>
              <ng-container *ngIf="isPetitioner && a.status === 'accepted'">
                <button type="button" (click)="openReschedulePrompt(a, 'cancelled')" [disabled]="busy">Cancel</button>
              </ng-container>
              <ng-container *ngIf="canReschedule(a)">
                <button type="button" (click)="openRescheduleForm(a)" [disabled]="busy" class="submit">Reschedule</button>
              </ng-container>
              <ng-container *ngIf="(isAttorney || isLegalAssistant || isAdmin) && a.status !== 'cancelled' && a.status !== 'reschedule_requested'">
                <button type="button" (click)="openCancelAppointmentConfirm(a)" [disabled]="busy">Cancel</button>
              </ng-container>
              <ng-container *ngIf="isPetitioner && (a.status === 'rejected' || a.status === 'cancelled' || a.status === 'reschedule_requested')">
                —
              </ng-container>
            </span>
          </td>
        </tr>
      </tbody>
    </table>

    <p *ngIf="!busy && appointments.length === 0" class="mt12">No upcoming events.</p>

    <section *ngIf="editingRescheduleAppointment" class="panel mt16">
      <h2 class="panelTitle">Reschedule appointment</h2>
      <p class="mt8">Propose a new date and time. The petitioner will be able to accept or reject.</p>
      <form (ngSubmit)="submitReschedule()" class="gridForm mt12">
        <label>
          Date and time
          <app-appointment-picker [(value)]="rescheduleScheduledAt" [required]="true" />
        </label>
        <label>
          Notes (optional)
          <input name="rescheduleNotes" type="text" [(ngModel)]="rescheduleNotes" class="input" maxlength="500" />
        </label>
        <div class="rowActions">
          <button type="submit" [disabled]="busy" class="submit">Reschedule and send invitations</button>
          <button type="button" (click)="cancelRescheduleForm()" [disabled]="busy">Cancel</button>
        </div>
      </form>
    </section>
  </section>

  <app-confirm-popup
    [open]="reschedulePromptOpen"
    title="Reschedule?"
    message="Do you want to reschedule this appointment? If yes, the attorney or admin can propose a new date and time."
    confirmText="Yes, reschedule"
    cancelText="No, cancel entirely"
    dismissText="Cancel"
    (confirm)="onReschedulePromptConfirm()"
    (cancel)="onReschedulePromptCancel()"
    (dismiss)="onReschedulePromptDismiss()"
  />

  <app-confirm-popup
    [open]="!!cancelAppointmentConfirmTarget"
    title="Cancel appointment?"
    message="Are you sure you want to cancel this appointment? The petitioner will see the appointment as cancelled."
    confirmText="Yes, cancel appointment"
    cancelText="No, keep it"
    [danger]="true"
    (confirm)="onCancelAppointmentConfirm()"
    (cancel)="onCancelAppointmentDismiss()"
  />

  <app-schedule-popup
    [open]="schedulePopupOpen"
    [cases]="cases"
    (close)="onSchedulePopupClose()"
    (created)="onSchedulePopupCreated()"
  />

  <app-confirm-popup
    [open]="showScheduleAskSuccessPopup"
    title="Appointment scheduled"
    [message]="scheduleAskSuccessMessage"
    confirmText="Undo"
    cancelText="OK"
    [danger]="true"
    (confirm)="onUndoScheduleAsk()"
    (cancel)="onDismissScheduleAskSuccess()"
  />
</main>
