<div>
  <h1>Users</h1>

  <section *ngIf="canCreate" class="panel">
    <h2 class="panelTitle">{{ editingUserId ? 'Edit user' : 'Create user' }}</h2>
    <p *ngIf="editingUserId" class="mt10">Editing: <strong>{{ uname }}</strong></p>

    <form (ngSubmit)="create()" class="gridForm">
      <label>
        Username
        <input name="uname" [(ngModel)]="uname" required class="input" [disabled]="busy || !!editingUserId" />
      </label>

      <label>
        Email
        <input name="email" [(ngModel)]="email" required class="input" />
      </label>

      <label>
        First name
        <input name="firstName" [(ngModel)]="firstName" class="input" />
      </label>

      <label>
        Last name
        <input name="lastName" [(ngModel)]="lastName" class="input" />
      </label>

      <label>
        Password
        <div class="inputWithToggle">
          <input
            name="password"
            [(ngModel)]="password"
            required
            minlength="8"
            class="input"
            [type]="showPassword ? 'text' : 'password'"
          />
          <button
            type="button"
            class="iconBtn"
            (click)="showPassword = !showPassword"
            [disabled]="busy"
            [attr.aria-label]="showPassword ? 'Hide password' : 'Show password'"
          >
            <svg *ngIf="!showPassword" viewBox="0 0 24 24" class="icon" aria-hidden="true">
              <path fill="currentColor" d="M12 5c6 0 10 7 10 7s-4 7-10 7S2 12 2 12s4-7 10-7Zm0 2C8 7 4.9 10.9 4.1 12c.8 1.1 3.9 5 7.9 5s7.1-3.9 7.9-5C19.1 10.9 16 7 12 7Zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5Z"/>
            </svg>
            <svg *ngIf="showPassword" viewBox="0 0 24 24" class="icon" aria-hidden="true">
              <path fill="currentColor" d="M3 5.3 4.3 4 20 19.7 18.7 21l-3.1-3.1A11 11 0 0 1 12 19C6 19 2 12 2 12a20 20 0 0 1 5.1-5.9L3 5.3Zm9 3.7c-.3 0-.6 0-.9.1l1.3 1.3c.4.4.6.9.6 1.6 0 .3 0 .6-.1.9l1.8 1.8c.2-.4.3-.9.3-1.4A3 3 0 0 0 12 9Zm0-4c6 0 10 7 10 7a20 20 0 0 1-4.6 5.4l-1.4-1.4A18 18 0 0 0 19.9 12C19.1 10.9 16 7 12 7c-.7 0-1.3.1-1.9.2L8.5 5.6C9.6 5.2 10.8 5 12 5Z"/>
            </svg>
          </button>
        </div>
      </label>

      <div class="rowActions">
        <button type="submit" [disabled]="busy" class="submit">{{ editingUserId ? 'Save' : 'Create' }}</button>
        <button *ngIf="editingUserId" type="button" (click)="requestCancelEdit()" [disabled]="busy">Cancel</button>
        <button type="button" (click)="refresh()" [disabled]="busy">Refresh</button>
      </div>
    </form>

    <p *ngIf="success" class="success" role="status" aria-live="polite">{{ success }}</p>
    <p *ngIf="error" class="error">{{ error }}</p>
  </section>

  <p *ngIf="!canCreate" class="mt16">You don’t have permission to create users.</p>

  <section class="mt16">
    <h2>All users</h2>
    <p *ngIf="busy && users.length === 0">Loading…</p>

    <table *ngIf="users.length > 0" class="table">
      <thead>
        <tr>
          <th class="th">Name</th>
          <th class="th">Username</th>
          <th class="th">Email</th>
          <th class="th">Role</th>
          <th class="th">Edit</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let u of users">
          <td class="td">{{ u.lastName || '' }}, {{ u.firstName || '' }}</td>
          <td class="td">{{ u.uname }}</td>
          <td class="td">{{ u.email }}</td>
          <td class="td">{{ roleTypeName(u.roleTypeId) }}</td>
          <td class="td">
            <button *ngIf="canCreate" type="button" (click)="editUser(u)" [disabled]="busy" class="submit">Edit</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <app-confirm-popup
    [open]="showCancelConfirm"
    title="Discard changes?"
    message="Any unsaved changes to this user will be lost."
    confirmText="Discard"
    cancelText="Keep editing"
    [danger]="true"
    (confirm)="cancelEdit()"
    (cancel)="showCancelConfirm = false"
  />
</div>
