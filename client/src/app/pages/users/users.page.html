<div>
  <h1>Users</h1>

  <section *ngIf="canCreate" class="panel">
    <h2 class="panelTitle">{{ editingUserId ? 'Edit user' : 'Create user' }}</h2>
    <p *ngIf="editingUserId" class="mt10">Editing: <strong>{{ uname }}</strong></p>

    <form (ngSubmit)="create()" class="gridForm">
      <label>
        First name
        <input name="firstName" [(ngModel)]="firstName" class="input" />
      </label>

      <label>
        Last name
        <input name="lastName" [(ngModel)]="lastName" class="input" />
      </label>

      <label *ngIf="!editingUserId">
        Role
        <select name="roleTypeId" [(ngModel)]="roleTypeId" class="input" [disabled]="busy || roleTypes.length === 0">
          <option *ngFor="let rt of createableRoleTypes" [ngValue]="rt.id">{{ rt.name }}</option>
        </select>
      </label>

      <label>
        <span class="labelLine">Username <span class="labelTooltip" title="Optional for respondent or respondent attorney" aria-label="Optional for respondent or respondent attorney">ⓘ</span></span>
        <input name="uname" [(ngModel)]="uname" class="input" [disabled]="busy || !!editingUserId" />
      </label>

      <label>
        <span class="labelLine">Email <span class="labelTooltip" title="Optional for respondent or respondent attorney" aria-label="Optional for respondent or respondent attorney">ⓘ</span></span>
        <input name="email" [(ngModel)]="email" type="email" class="input" />
      </label>

      <label>
        <span class="labelLine">Password <span class="labelTooltip" title="Optional for respondent or respondent attorney" aria-label="Optional for respondent or respondent attorney">ⓘ</span></span>
        <div class="inputWithToggle">
          <input
            name="password"
            [(ngModel)]="password"
            class="input"
            [type]="showPassword ? 'text' : 'password'"
          />
          <button
            type="button"
            class="iconBtn"
            (click)="showPassword = !showPassword"
            [disabled]="busy"
            [attr.aria-label]="showPassword ? 'Hide password' : 'Show password'"
          >
            <svg *ngIf="!showPassword" viewBox="0 0 24 24" class="icon" aria-hidden="true">
              <path fill="currentColor" d="M12 5c6 0 10 7 10 7s-4 7-10 7S2 12 2 12s4-7 10-7Zm0 2C8 7 4.9 10.9 4.1 12c.8 1.1 3.9 5 7.9 5s7.1-3.9 7.9-5C19.1 10.9 16 7 12 7Zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5Z"/>
            </svg>
            <svg *ngIf="showPassword" viewBox="0 0 24 24" class="icon" aria-hidden="true">
              <path fill="currentColor" d="M3 5.3 4.3 4 20 19.7 18.7 21l-3.1-3.1A11 11 0 0 1 12 19C6 19 2 12 2 12a20 20 0 0 1 5.1-5.9L3 5.3Zm9 3.7c-.3 0-.6 0-.9.1l1.3 1.3c.4.4.6.9.6 1.6 0 .3 0 .6-.1.9l1.8 1.8c.2-.4.3-.9.3-1.4A3 3 0 0 0 12 9Zm0-4c6 0 10 7 10 7a20 20 0 0 1-4.6 5.4l-1.4-1.4A18 18 0 0 0 19.9 12C19.1 10.9 16 7 12 7c-.7 0-1.3.1-1.9.2L8.5 5.6C9.6 5.2 10.8 5 12 5Z"/>
            </svg>
          </button>
        </div>
      </label>

      <div class="rowActions">
        <button type="submit" [disabled]="busy" class="submit">{{ editingUserId ? 'Save' : 'Create' }}</button>
        <button *ngIf="editingUserId" type="button" (click)="requestCancelEdit()" [disabled]="busy">Cancel</button>
        <button type="button" (click)="refresh()" [disabled]="busy">Refresh</button>
      </div>
    </form>

    <p *ngIf="success" class="success" role="status" aria-live="polite">{{ success }}</p>
    <p *ngIf="error" class="error">{{ error }}</p>
  </section>

  <p *ngIf="!canCreate" class="mt16">You don’t have permission to create users.</p>

  <section class="mt16">
    <h2>All users</h2>
    <div class="rowActions mt8" *ngIf="users.length > 0">
      <label class="filterLabel">
        Filter by role
        <select name="roleFilter" [(ngModel)]="roleFilter" class="input" style="max-width: 200px;">
          <option [ngValue]="null">All roles</option>
          <option *ngFor="let rt of roleTypes" [ngValue]="rt.id">{{ rt.name }}</option>
        </select>
      </label>
    </div>
    <p *ngIf="busy && users.length === 0">Loading…</p>

    <table *ngIf="users.length > 0" class="table mt12">
      <thead>
        <tr>
          <th class="th thSortable" (click)="setSort('name')" [attr.aria-sort]="sortBy === 'name' ? (sortDir === 'asc' ? 'ascending' : 'descending') : null">
            Name <span *ngIf="sortBy === 'name'" class="sortIcon">{{ sortDir === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th class="th thSortable" (click)="setSort('uname')" [attr.aria-sort]="sortBy === 'uname' ? (sortDir === 'asc' ? 'ascending' : 'descending') : null">
            Username <span *ngIf="sortBy === 'uname'" class="sortIcon">{{ sortDir === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th class="th thSortable" (click)="setSort('email')" [attr.aria-sort]="sortBy === 'email' ? (sortDir === 'asc' ? 'ascending' : 'descending') : null">
            Email <span *ngIf="sortBy === 'email'" class="sortIcon">{{ sortDir === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th class="th thSortable" (click)="setSort('role')" [attr.aria-sort]="sortBy === 'role' ? (sortDir === 'asc' ? 'ascending' : 'descending') : null">
            Role <span *ngIf="sortBy === 'role'" class="sortIcon">{{ sortDir === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th class="th">Edit</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let u of filteredUsers">
          <td class="td">{{ u.lastName || '' }}, {{ u.firstName || '' }}</td>
          <td class="td">{{ u.uname }}</td>
          <td class="td">{{ u.email }}</td>
          <td class="td">{{ roleTypeName(u.roleTypeId) }}</td>
          <td class="td">
            <button *ngIf="canCreate" type="button" (click)="editUser(u)" [disabled]="busy" class="submit">Edit</button>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="!busy && users.length > 0 && filteredUsers.length === 0" class="muted mt8">No users match the selected role filter.</p>
  </section>

  <app-confirm-popup
    [open]="showCancelConfirm"
    title="Discard changes?"
    message="Any unsaved changes to this user will be lost."
    confirmText="Discard"
    cancelText="Keep editing"
    [danger]="true"
    (confirm)="cancelEdit()"
    (cancel)="showCancelConfirm = false"
  />

  <app-confirm-popup
    [open]="showSendEmailConfirm"
    title="Send invitation email?"
    message="Do you want to send an invitation email to this user so they can log in, finish registration, and change their password? You may prefer not to send the email for respondent attorneys or respondents who should not use this app."
    confirmText="Send email"
    cancelText="Create without email"
    (confirm)="createUserWithInviteChoice(true)"
    (cancel)="createUserWithInviteChoice(false)"
  />
</div>
